<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bullion Fetch</title>
    
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="shortcut icon" href="/favicon.ico" />
    
    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/style.css">
    <style>
        body {
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .card {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        .product-image {
            max-width: 200px;
            height: auto;
        }
        .loading {
            text-align: center;
            padding: 20px;
        }
        .error-alert {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <a href="index.html" class="btn btn-outline-secondary btn-sm">&larr; Back to Home</a>
            <h1>Bullion Information</h1>
            <div style="width: 100px;"></div>
        </div>
        
        <div id="product-container">
            <div class="alert alert-info" role="alert">
                <div class="spinner-border spinner-border-sm me-2" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                Loading product information...
            </div>
        </div>
    </div>

    <script>
        // Define all materials to fetch
        const materials = [
            { name: 'Sterling Silver', url: 'https://www.cooksongold.com/Grain-and-Casting-Pieces/Sterling-Silver-Grain,-100--------Recycled-Silver-prcode-ASA-000' },
            { name: 'Fine Silver', url: 'https://www.cooksongold.com/Grain-and-Casting-Pieces/Fine-Silver-Grain,-100-Recycled---Silver-prcode-ASF-000' },
            { name: '9ct Gold', url: 'https://www.cooksongold.com/Grain-and-Casting-Pieces/9ct-Casting-Yellow-Grain,-100-----Recycled-Gold-prcode-AAB-000' },
            { name: '14ct Gold', url: 'https://www.cooksongold.com/Grain-and-Casting-Pieces/14ct-Ay-Yellow-Grain,-100-Recycled-Gold-prcode-AGE-000' },
            { name: '18ct Gold', url: 'https://www.cooksongold.com/Grain-and-Casting-Pieces/18ct-Hcb-Yellow-Grain,-100--------Recycled-Gold-prcode-ALO-000' },
            { name: 'Fine Gold', url: 'https://www.cooksongold.com/Grain-and-Casting-Pieces/Fine-Gold-Grain-Minimum-99.96-Au,-100-Recycled-Gold-prcode-ARZ-000' },
            { name: 'Palladium', url: 'https://www.cooksongold.com/Grain-and-Casting-Pieces/Palladium-Casting-Pieces-prcode-APAL-000' },
            { name: 'Platinum', url: 'https://www.cooksongold.com/Grain-and-Casting-Pieces/Platinum-Hc-Casting-Pieces-prcode-BXB-000' }
        ];
        
        // CORS proxy URLs (many public options for improved compatibility)
        // Note: public proxies can be unreliable or rate-limited. Prefer a server-side proxy for production.
        const corsProxies = [
            'https://api.allorigins.win/raw?url=',
            'https://api.allorigins.cf/raw?url=',
            'https://thingproxy.freeboard.io/fetch/',
            'https://cors-anywhere.herokuapp.com/',
            'https://api.codetabs.com/v1/proxy?quest=',
            'https://cors.bridged.cc/',
            'https://corsproxy.io/?',
            'https://yacdn.org/proxy/',
            'https://proxy.cors.sh/',
            'https://cors.eu.org/?u='
        ];

        async function fetchProductInfo(productUrl) {
            for (let proxy of corsProxies) {
                try {
                    const proxyUrl = proxy + encodeURIComponent(productUrl);
                    const response = await fetch(proxyUrl);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const html = await response.text();
                    return html;
                } catch (error) {
                    console.log(`Proxy ${proxy} failed:`, error);
                    continue;
                }
            }
            
            return null;
        }

        function extractProductInfo(html, productUrl) {
            // Parse HTML
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // Extract product information
            const productName = doc.querySelector('h1, [data-product-name], .product-title')?.textContent.trim() || 'Product Name';
            const productPrice = extractPrice(doc);
            const productDescription = doc.querySelector('[data-product-description], .description, .product-description')?.textContent.trim() || 'No description available';
            const productImage = doc.querySelector('img[data-product-image], .product-image img')?.src || '';
            
            return {
                name: productName,
                price: productPrice,
                description: productDescription,
                image: productImage,
                url: productUrl
            };
        }

        function extractPrice(doc) {
            // Try multiple selectors to find price
            const priceSelectors = [
                '#b_pricing_now',
                '.product-price',
                '[data-price]',
                '.price',
                '.product-pricing',
                'span[class*="price"]'
            ];
            
            for (let selector of priceSelectors) {
                const element = doc.querySelector(selector);
                if (element) {
                    return element.textContent.trim();
                }
            }
            
            return 'Price not available';
        }

        function displayAllProducts(productsData) {
            const container = document.getElementById('product-container');
            
            let html_content = '<div class="row">';
            
            productsData.forEach(product => {
                html_content += `
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title">${product.name}</h5>
                `;
                
                if (product.image) {
                    html_content += `<img src="${product.image}" alt="${product.name}" class="product-image mb-3" />`;
                }
                
                html_content += `
                                <p class="card-text"><strong>Price:</strong> ${product.price}</p>
                                <p class="card-text"><strong>Description:</strong> ${product.description}</p>
                                <a href="${product.url}" target="_blank" class="btn btn-primary btn-sm">View on Cookson Gold</a>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html_content += '</div>';
            container.innerHTML = html_content;
        }

        function displayError() {
            const container = document.getElementById('product-container');
            container.innerHTML = `
                <div class="alert alert-danger">
                    <h4 class="alert-heading">Unable to Fetch Product Information</h4>
                    <p>Unfortunately, we couldn't retrieve the product information from Cookson Gold due to website access restrictions.</p>
                    <p>Please visit <a href="https://www.cooksongold.com/" target="_blank" class="alert-link">Cookson Gold directly</a> to view current prices.</p>
                </div>
            `;
        }

        async function loadAllProducts() {
            const productsData = [];
            
            for (let material of materials) {
                const html = await fetchProductInfo(material.url);
                
                if (html) {
                    const productInfo = extractProductInfo(html, material.url);
                    productsData.push(productInfo);
                } else {
                    // Add error placeholder for this product
                    productsData.push({
                        name: material.name,
                        price: 'Unable to load',
                        description: 'Could not fetch information',
                        image: '',
                        url: material.url
                    });
                }
                
                // Add 2 second delay between requests (except after the last one)
                if (material !== materials[materials.length - 1]) {
                    await new Promise(resolve => setTimeout(resolve, 4000));
                }
            }
            
            if (productsData.length > 0) {
                displayAllProducts(productsData);
            } else {
                displayError();
            }
        }

        // Load all products when page loads
        document.addEventListener('DOMContentLoaded', loadAllProducts);
    </script>
</body>
</html>
