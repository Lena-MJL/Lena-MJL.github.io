<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SG Calculator</title>

    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="shortcut icon" href="/favicon.ico" />

    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/style.css">
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            overflow: visible;
        }

        .container {
            max-width: 100% !important;
            width: 98%;
            padding: 0;
            margin: 0 1%;
        }

        h2 {
            margin: 10px 0 10px 0;
        }

        .sg-table-container {
            width: 100%;
            margin: 0;
            padding: 0;
        }

        .sg-table {
            width: 100%;
            table-layout: fixed;
            border-collapse: collapse;
            margin: 0;
        }

        .sg-table th,
        .sg-table td {
            padding: 6px 8px;
            text-align: center;
            border: 1px solid #dee2e6;
            white-space: nowrap;
            min-width: 130px;
            width: 130px;
        }

        .sg-table th {
            background-color: #f8f9fa;
        }

        .sg-table th:first-child,
        .sg-table td:first-child {
            background-color: #fff;
            text-align: left;
            width: 195px;
            /* 1.5x the standard column width */
            position: sticky;
            left: 0;
            z-index: 1;
        }

        .sg-table thead {
            position: sticky;
            top: 0;
            z-index: 2;
        }

        .sg-table thead tr:first-child th:first-child {
            z-index: 3;
        }

        .material-input {
            width: 100%;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <a href="/" class="btn btn-link">&larr; Back to Home</a>
            <h2 class="m-0">SG Calculator</h2>
            <h4>Prices of bullion based on links provided at the bottom. Please wait until they are loaded and displayed
                in the header of the table to see the price estimates or use straight away for pure weight calculations.
            </h4>
            <div style="width: 100px;"></div> <!-- Spacer for balance -->
        </div>
        <div class="sg-table-container">
            <table class="sg-table" id="sg-table">
                <thead>
                    <tr id="header-row">
                        <th>Source material</th>
                        <!-- Material headers will be rendered here -->
                    </tr>
                </thead>
                <tbody id="calculator-grid">
                    <!-- Rows will be rendered here -->
                </tbody>
            </table>
        </div>
    </div>
    <script>
        // Define the materials list
        const materials = [
            "Wax", 
            "925 silver", "fine silver",
            "9K gold", "14K gold", "18K gold", "22K gold", "24K gold",
            "palladium",
            "platinum", 
            "titanium",
            "brass",
            "bronze",
        ];
        const relative_sg_wax = {
            "Wax": 1.0,
            "925 silver": 10.30,
            "fine silver": 10.53,
            "9K gold": 11.2,
            "14K gold": 14.1,
            "18K gold": 15.7,
            "22K gold": 17.8,
            "24K gold": 19.5,
            "platinum": 20.6,
            "palladium": 12.02,
            "brass": 8.5,
            "bronze": 8.8,
            "titanium": 4.51,
        };

        // Get the header row and calculator grid elements
        const headerRow = document.getElementById('header-row');
        const calculatorGrid = document.getElementById('calculator-grid');

        // First, create the header cells for material names
        for (let j = 0; j < materials.length; j++) {
            const th = document.createElement('th');
            th.textContent = materials[j];
            headerRow.appendChild(th);
        }

        // Then, create rows for each material
        for (let i = 0; i < materials.length; i++) {
            // Create a table row
            const tr = document.createElement('tr');
            tr.id = `material-row-${i}`;

            // Create the first cell with material name and input
            const firstCell = document.createElement('td');

            // Create label and input in a container
            const inputContainer = document.createElement('div');

            const label = document.createElement('label');
            label.textContent = materials[i] + " (g)";
            label.setAttribute('for', `input${i}`);

            const input = document.createElement('input');
            input.type = 'number';
            input.className = 'form-control material-input';
            input.id = `input${i}`;
            input.placeholder = `Enter value`;
            input.step = '0.01';

            // Add label and input to container
            inputContainer.appendChild(label);
            inputContainer.appendChild(input);

            // Add input container to first cell
            firstCell.appendChild(inputContainer);

            // Add first cell to row
            tr.appendChild(firstCell);

            // Create cells for each material result
            for (let j = 0; j < materials.length; j++) {
                const td = document.createElement('td');
                td.textContent = "-";  // Start with "-" instead of material name
                td.id = `result-${i}-${j}`;
                tr.appendChild(td);
            }

            // Add row to calculator grid
            calculatorGrid.appendChild(tr);

            // Add event listener to input to update results
            input.addEventListener('input', function () {
                updateResults(i, this.value);
            });
        }

        // Function to update results based on input value
        function updateResults(materialIndex, value) {
            if (!value) {
                // Display "-" in all cells when input is empty
                for (let j = 0; j < materials.length; j++) {
                    document.getElementById(`result-${materialIndex}-${j}`).textContent = "-";
                }
                return;
            }

            const inputValue = parseFloat(value);
            const sourceMaterial = materials[materialIndex];
            const sourceRatio = relative_sg_wax[sourceMaterial];

            // Update each result item with the calculated value
            for (let j = 0; j < materials.length; j++) {
                const targetMaterial = materials[j];
                const targetRatio = relative_sg_wax[targetMaterial];

                // Calculate the equivalent weight based on relative specific gravity
                const equivalentWeight = (inputValue * targetRatio / sourceRatio).toFixed(2);

                const resultElement = document.getElementById(`result-${materialIndex}-${j}`);
                resultElement.innerHTML = `${equivalentWeight}g`;

                if (window.bullionPrices === undefined) {
                    continue; // bullion prices not loaded yet
                } else {
                    const found = window.bullionPrices[materials[j]];
                    if (found && found.price) {
                        // append price on new line
                        const price = found.price.substring(1); // remove currency symbol
                        resultElement.innerHTML += `<br><small>£${(price * equivalentWeight).toFixed(2)}</small>`;
                    }
                }
            }
        }
    </script>

    <!-- Embedded bullion prices (reuse shared fetcher) -->
    <div class="container mt-4" style="margin-top: 20px;">
        <h3>Bullion prices from cooksongold.com</h3>
        <div id="bullion-embedded">Loading bullion prices…</div>
    </div>

    <script src="js/bullion_fetcher.js"></script>
    <script>
        async function embedBullion() {
            const container = document.getElementById('bullion-embedded');
            container.innerHTML = '<div class="alert alert-info">Loading bullion prices…</div>';
            try {
                // fetch prices (2s delay between requests)
                const results = await BullionFetcher.fetchMultiple();
                // render simple list
                let out = '<div class="row">';
                results.forEach(r => {
                    out += `
                        <div class="col-md-3 mb-2">
                            <div class="card">
                                <div class="card-body p-2">
                                    <strong>${r.name}</strong>
                                    <span class="text-muted"><a href="${r.url}" target="_blank">Product link</a></span>
                                    <br>
                                    <span class="text-muted">${r.price} per gram</span>

                                    <!--${r.cached ? '<div class="small text-muted">cached</div>' : ''} -->
                                </div>
                            </div>
                        </div>
                    `;
                });
                out += '</div>';
                container.innerHTML = out;

                // expose prices map for other scripts
                window.bullionPrices = results.reduce((m, v) => { m[v.name] = v; return m; }, {});

                // update table headers in this page where material names match
                const headerRow = document.getElementById('header-row');
                if (headerRow) {
                    // headerRow children correspond to materials in same order, first child is Source material
                    Array.from(headerRow.children).forEach(th => {
                        const name = th.textContent.trim();
                        const found = window.bullionPrices[name];
                        if (found && found.price) {
                            // append price small
                            th.innerHTML = `${name}<div class="small text-muted">${found.price}/g</div>`;
                        }
                    });
                }

            } catch (e) {
                console.error(e);
                container.innerHTML = '<div class="alert alert-danger">Unable to load bullion prices.</div>';
            }
        }

        document.addEventListener('DOMContentLoaded', embedBullion);
    </script>
</body>

</html>